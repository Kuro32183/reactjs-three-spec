'use strict';(function(n,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(n=n||self,r(n.troika_worker_utils={}))})(this,function(n){function r(){function b(e,c){h++;var u=0;try{c===q&&k();var t=0<e&&f(c);t?t.call(c,a(function(a){u++;b(1,a)}),a(function(a){u++;b(-1,a)})):(l=e,m=c,d||(setTimeout(g,0),d=1))}catch(B){l||u||b(-1,B)}}function g(){var a=e;d=0;e=[];a.forEach(c)}function c(a){a()}function f(a){a=a&&(p(a)||"object"===
typeof a)&&a.then;return p(a)&&a}function a(a){var b=0;return function(){for(var e=[],d=arguments.length;d--;)e[d]=arguments[d];b++||a.apply(this,e)}}function k(){throw new TypeError("Chaining cycle detected");}var l=0,e=[],m,d=0,h=0,t=a(function(a){h||b(1,a)}),n=a(function(a){h||b(-1,a)}),p=function(a){return"function"===typeof a},q={then:function(a,b){var h=r();e.push(function(){var e=0<l?a:b;if(p(e))try{var d=e(m);d===h&&k();var c=f(d);c?c.call(d,h.resolve,h.reject):h.resolve(d)}catch(C){h.reject(C)}else h[0<
l?"resolve":"reject"](m)});l&&!d&&(setTimeout(g,0),d=1);return h},resolve:t,reject:n};return q}function D(){var b,g,c=new Promise(function(c,a){b=c;g=a});return{then:c.then.bind(c),resolve:b,reject:g}}function E(){function b(a,k){var l=a.id,e=a.name,m=a.dependencies;void 0===m&&(m=[]);var d=a.init;void 0===d&&(d=function(){});a=a.getTransferables;void 0===a&&(a=null);if(!f[l])try{m=m.map(function(a){a&&a.isWorkerModule&&(b(a,function(a){if(a instanceof Error)throw a;}),a=f[a.id].value);return a}),
d=c("<"+e+">.init",d),a&&(a=c("<"+e+">.getTransferables",a)),e=null,"function"===typeof d?e=d.apply(void 0,m):console.error("worker module init function failed to rehydrate"),f[l]={id:l,value:e,getTransferables:a},k(e)}catch(h){h&&h.noLog||console.error(h),k(h)}}function g(a,b){function c(a){try{var d=f[k].getTransferables&&f[k].getTransferables(a);d&&Array.isArray(d)&&d.length||(d=void 0);b(a,d)}catch(y){console.error(y),b(y)}}var e,k=a.id;a=a.args;f[k]&&"function"===typeof f[k].value||b(Error("Worker module "+
k+": not found or its 'init' did not return a function"));try{var d=(e=f[k]).value.apply(e,a);d&&"function"===typeof d.then?d.then(c,function(a){return b(a instanceof Error?a:Error(""+a))}):c(d)}catch(h){b(h)}}function c(a,b){var c=void 0;self.troikaDefine=function(a){return c=a};a=URL.createObjectURL(new Blob(["/** "+a.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+b+"\n)"],{type:"application/javascript"}));try{importScripts(a)}catch(e){console.error(e)}URL.revokeObjectURL(a);delete self.troikaDefine;
return c}var f=Object.create(null);self.addEventListener("message",function(a){var c=a.data,f=c.messageId;a=c.action;c=c.data;try{"registerModule"===a&&b(c,function(a){a instanceof Error?postMessage({messageId:f,success:!1,error:a.message}):postMessage({messageId:f,success:!0,result:{isCallable:"function"===typeof a}})}),"callModule"===a&&g(c,function(a,b){a instanceof Error?postMessage({messageId:f,success:!1,error:a.message}):postMessage({messageId:f,success:!0,result:a},b||void 0)})}catch(e){postMessage({messageId:f,
success:!1,error:e.stack})}})}function v(b){function g(){for(var a=[],b=arguments.length;b--;)a[b]=arguments[b];m||(m=z(k,"registerModule",g.workerModuleData));return m.then(function(b){if(b.isCallable)return z(k,"callModule",{id:l,args:a});throw Error("Worker module function was called but `init` did not return a callable function");})}if(!(b&&"function"===typeof b.init||w))throw Error("requires `options.init` function");var c=b.dependencies,f=b.init,a=b.getTransferables,k=b.workerId;null==k&&(k=
"#default");var l="workerModule"+ ++F,e=b.name||l,m=null;c=c&&c.map(function(a){"function"!==typeof a||a.workerModuleData||(w=!0,a=v({workerId:k,name:"<"+e+"> function dependency: "+a.name,init:"function(){return (\n"+q(a)+"\n)}"}),w=!1);a&&a.workerModuleData&&(a=a.workerModuleData);return a});g.workerModuleData={isWorkerModule:!0,id:l,name:e,dependencies:c,init:q(f),getTransferables:a&&q(a)};return g}function q(b){b=b.toString();!/^function/.test(b)&&/^\w+\s*\(/.test(b)&&(b="function "+b);return b}
function G(b){var g=A[b];g||(g=q(E),g=A[b]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+b.replace(/\*/g,"")+" **/\n\n;("+g+")()"],{type:"application/javascript"}))),g.onmessage=function(b){b=b.data;var c=b.messageId,a=p[c];if(!a)throw Error("WorkerModule response with empty or unknown messageId");delete p[c];p.count--;a(b)});return g}function z(b,g,c){var f=x(),a=++H;p[a]=function(a){a.success?f.resolve(a.result):f.reject(Error("Error in worker "+g+" call: "+a.error))};
p._count++;1E3<p.count&&console.warn("Large number of open WorkerModule requests, some may not be returning");G(b).postMessage({messageId:a,action:g,data:c});return f}var x="function"===typeof Promise?D:r,F=0,H=0,w=!1,A=Object.create(null),p=Object.create(null);p._count=0;var I=v({name:"Thenable",dependencies:[x],init:function(b){return b}});n.Thenable=x;n.ThenableWorkerModule=I;n.defineWorkerModule=v;n.stringifyFunction=q;Object.defineProperty(n,"__esModule",{value:!0})})
